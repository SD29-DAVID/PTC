<?php
session_start(); include('includes/config.inc.php');   function destroy() { $_SESSION['captcha']=null;  } function destroy2() { $_SESSION['captcha']=null; exit(); } function error_message($msg) { global $fail_code; echo $msg; destroy2(); }    if(!isset($_COOKIE["usNick"]) || !isset($_COOKIE["usPass"])) { error_message('Not logged in or session cookie expired.\nPlease log-in again.'); }  if(!isset($_GET['code']) || $_GET['code']!=$_SESSION['captcha']) { $user = uc($_COOKIE["usNick"]); $ip=getRealIP(); $date = date("F j, Y"); $time = date("g:i a"); $myDb->connect(); mysql_query("INSERT INTO yob_cheaters(user,ip, date, time) VALUES ('$user','$ip', '$date','$time')") or die(mysql_error()); error_message('Wrong security code!<br><br>This is a bot detection and your account will be deleted if this persists. Please contact support for further information.'); $myDb->close(); }  $user = uc($_COOKIE["usNick"]); $pass = $_COOKIE["usPass"]; $myDb->connect(); $user_query = mysql_query("SELECT * FROM yob_users WHERE username='$user' AND password='$pass'") or die(mysql_error()); $myDb->close(); if(mysql_num_rows($user_query)==0) { error_message('Bad username/password.\nPlease log-in again.'); }  $ad_id = limpiar($_GET["ad"]); $myDb->connect(); $ad_query = mysql_query("SELECT id FROM yob_ads WHERE id='$ad_id' AND tipo='ads' AND CONVERT(members,UNSIGNED) < CONVERT(plan,UNSIGNED)") or die(mysql_error()); $ad_query2 = mysql_query("SELECT id FROM yob_ads WHERE id='$ad_id' AND tipo='premiumads' AND CONVERT(members,UNSIGNED) < CONVERT(plan,UNSIGNED)") or die(mysql_error()); $myDb->close(); if ((mysql_num_rows($ad_query)==0) && (mysql_num_rows($ad_query2)==0)) { error_message('Too late! Ad expired!'); }   $myDb->connect(); $visit_query = mysql_query("SELECT * FROM yob_ads WHERE user = '$user' AND ident= '$ad_id' AND tipo='visit'") or die(mysql_error()); $myDb->close(); $actual_time= date(time());  $ip=getRealIP(); if(mysql_num_rows($visit_query)>0) { $visit_row = mysql_fetch_array($visit_query); $lastvisit_time=$visit_row['visitime']; if($actual_time < date($lastvisit_time + (24 * 60 * 60))) { error_message('You have to wait 24h before visiting the same sponsor again.'); } $myDb->connect(); mysql_query("UPDATE yob_ads SET visitime='$actual_time', ip='$ip' WHERE user='$user' AND ident='$ad_id' AND tipo='visit'") or die(mysql_error()); $myDb->close(); } else { $myDb->connect(); mysql_query("INSERT INTO yob_ads(user,ip,ident,tipo,visitime) VALUES ('$user','$ip','$ad_id','visit','$actual_time')") or die(mysql_error()); $myDb->close(); }  $myDb->connect(); mysql_query("UPDATE yob_ads SET members = CONVERT(members,UNSIGNED) + 1 WHERE id='$ad_id'") or die(mysql_error()); $myDb->close();   $user_row = mysql_fetch_array($user_query);  foreach(array('click','referalclick','premiumclick','premiumreferalc') as $item) { $myDb->connect(); $query = mysql_query("SELECT price FROM yob_config WHERE item='$item' AND howmany='1'") or die(mysql_error()); $row = mysql_fetch_row($query); $myDb->close(); ${$item} = $row[0]; }  $myDb->connect(); mysql_query("UPDATE yob_users SET money = money + IF(account='premium',$premiumclick,$click), visits = CONVERT(visits,UNSIGNED) + 1 WHERE username='$user'") or die(mysql_error()); $myDb->close();  $referer=$user_row['referer']; if ($referer!=''){ $myDb->connect(); mysql_query("UPDATE yob_users SET money = money + IF(account='premium',$premiumreferalc,$referalclick), referalvisits = CONVERT(referalvisits,UNSIGNED) + 1 WHERE username='$referer'") or die(mysql_error()); $myDb->close(); } destroy(); $url_clean=limpiar($_GET["url"]); header('Location: '.$url_clean.''); ?>